---
# vim:ft=markdown:tw=76
title:  CF-M0001: Database Scheme Fix Migration
url:    /docs/migrations/cf/cf-m0001/index.html
format: markdown
--- |-

# Overview

We recently discovered an issue with our CF kit that affects versions 1.1.0
to 1.1.2. Due to a YAML-related error, the Locket and Diego databases were
configured to use the database name `postgres` by default. While this does not
affect day-to-day nominal operation of CF, we still see this an issue that needs
to be corrected as soon as possible.

Please note that although your databases may already contain `locketdb` and
`diegodb` tables, they are empty and unused. All data was written to `postgres`.


# Impact

We believe the impact to be minimal to the stability and runtime of your CF
deployments. However, it is in the best interest to correct this problem as
confusion stemming from unorganized data may arise.

The fix for this issue will require downtime. In our testing, apps were
inaccessible for 15 minutes while the fix was being applied.


# Instructions on Applying Fix

The following are step-by-step instructions on how to successfully migrate Locket
and Diego data from `postgres` and into their respective databases. This guide
will mention when downtime approximately starts and ends.

## Step 1: Get a Baseline

Ensure your CF deployment is running nominally by running smoke tests. If tests
pass, continue to step 2. Otherwise, please diagnose and correct your errors;
do not continue until smoke tests pass.

Running smoke tests will help you understand when, if ever, your CF deployment
stopped working in case data migration fails.

## Step 2: Stage Genesis Environment File for Deploy

The Genesis CF Kit version 1.2 includes the fix to CF-M0001. Download it
via `genesis download cf/1.2` in your CF deployments folder. Then, edit your
environment file and set `version:` to `version: 1.2`. Do not deploy yet, that
step will come last.

## Step 3: Stop All BBS VMs

Perform a `monit stop all` on all BBS instances of your CF deployment.
Approximately 2 minutes after stopping all processes, routes to your apps will
no longer work and downtime begins.

## Step 4: Migrate Data

On your master Postgres VM, execute the following statements:

    sudo -i
    mkdir /var/vcap/store/migration
    cd /var/vcap/store/migration


Dump the data in the `postgres` database by individual table:

    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -t locks postgres > postgres.locks.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t actual_lrps postgres > postgres.actual_lrps.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t configurations postgres > postgres.configurations.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t desired_lrps postgres > postgres.desired_lrps.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t domains postgres > postgres.domains.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t tasks postgres > postgres.tasks.sql;

Import the recently exported data from `postgres` into their proper databases:

    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 locketdb < postgres.locks.sql;
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 diegodb < postgres.actual_lrps.sql;
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 diegodb < postgres.configurations.sql;
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 diegodb < postgres.desired_lrps.sql;
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 diegodb < postgres.domains.sql;
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 diegodb < postgres.tasks.sql;

## Step 5: Verify the Data Migration was Successful

Export the recently imported data:

    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -t locks locketdb > locketdb.locks.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t actual_lrps diegodb > diegodb.actual_lrps.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t configurations diegodb > diegodb.configurations.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t desired_lrps diegodb > diegodb.desired_lrps.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t domains diegodb > diegodb.domains.sql;
    /var/vcap/packages/postgres/bin/pg_dump -U vcap -p 6432 -c -t tasks diegodb > diegodb.tasks.sql;

Verify the recently exported data has no difference from the originally exported
data:


    diff postgres.locks.sql locketdb.locks.sql;
    diff postgres.actual_lrps.sql diegodb.actual_lrps.sql;
    diff postgres.configurations.sql diegodb.configurations.sql;
    diff postgres.desired_lrps.sql diegodb.desired_lrps.sql;
    diff postgres.domains.sql diegodb.domains.sql;
    diff postgres.tasks.sql diegodb.tasks.sql;


If all went well, there should be no output from any of those `diff` commands.

## Step 6: Rename Old Databases

To ensure no processes reference old database tables, rename them:

    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE locks RENAME TO locks_old";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE actual_lrps RENAME TO actual_lrps_old";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE configurations RENAME TO configurations_old";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE desired_lrps RENAME TO desired_lrps_old";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE domains RENAME TO domains_old";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "ALTER TABLE tasks RENAME TO tasks_old";


## Step 7: Redeploy Genesis Environment

Execute `genesis deploy` of the affected environment, ensuring
you've followed step 2. CF will now deploy with proper references to the
database names.

If all went well, BBS will begin running again and routes will restore within a
minute after deploying. Downtime ends here.

## Step 8: Cleanup & Verification (Final step)

Execute smoke tests to verify that your redeployed CF environment is nominal.
To finish, you may delete the old tables once you are confident your data
migration was successful:

    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE locks_old CASCADE";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE actual_lrps_old CASCADE";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE configurations_old CASCADE";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE desired_lrps_old CASCADE";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE domains_old CASCADE";
    /var/vcap/packages/postgres/bin/psql -U vcap -p 6432 postgres -c "DROP TABLE tasks_old CASCADE";

# Conclusion

If you have concerns about CF-M0001, please stop by our [Slack
channel](/community/#slack) for support.
