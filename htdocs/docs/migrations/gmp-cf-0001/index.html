<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,target-densitydpi=device-dpi">
<meta name="generator" content="verse">
<meta name="X-UA-Compatible" content="IE=edge">


<title>Genesis</title>


<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/css/libs.css?2">
<link rel="stylesheet" href="/css/main.css?2">
<link rel="alternate home" type="application/rss+xml" title="Genesis - RSS feed" href="/feed.xml">
</head>
<body class="dark-load">
	<header id="top-nav" class="top-nav page-header">
		<div class="container">
			<a class="logo smooth-scroll" href="/">
				<img class="logo-white" alt="Stark & Wayne" src="/img/logo.png?2" />
			</a>
			<nav class="top-menu">
				<ul class="sf-menu">
					<li><a href="/">Home</a></li>
					<li><a href="/download">Download</a></li>
					<li><a href="/community">Community</a></li>
					<li><a href="/docs/getting-started">Docs</a></li>
					<li><a href="/dev">Developers</a></li>
				</ul>
			</nav>
			<div id="mobile-menu">
				<div class="inner-wrap">
					<nav>
						<ul class="nav_menu">
							<li><a href="/">Home</a></li>
							<li><a href="/download">Download</a></li>
							<li><a href="/docs">Documentation</a></li>
							<li><a href="/dev">Developers</a></li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</header>

	<section id="top" class="display-page img-parallax bg-mask background-image"
         data-image="/img/hbg.jpg">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>GMP-CF-0001 - Database Scheme Fix Migration</h1>
      </div>
    </div>
  </div>
</section>


<section class="page">

  <div id="container" class="container">
    <div class="row">
      <div class="col-md-3 toc">
        
      </div>
      <div class="col-md-8 col-md-push-1">
        <div class="content">
        <h1>Overview</h1>

<p>We recently discovered an issue affecting versions 1.1.0, 1.1.1 and 1.1.2 of
the Genesis Cloud Foundry Kit.   Locket and Diego were incorrectly configured to place
their tables in the <code>postgres</code> database, instead of their dedicated
<code>locketdb</code> and <code>diegodb</code> databases.</p>

<p>While this does not affect day-to-day operation of Cloud Foundry, we
still see this an issue that needs to be corrected as soon as possible.</p>

<p>Please note that although your PostgreSQL instance may already contain
<code>locketdb</code> and <code>diegodb</code> databases, they are empty and unused. All tables
that should be in those databases were instead created in the <code>postgres</code>
database.</p>

<h1>Impact</h1>

<p>We believe the impact to be minimal to the stability and runtime of your Cloud Foundry
deployments. However, it is in the best interest to correct this problem as
confusion stemming from unorganized data may arise.</p>

<p>The fix for this issue will require downtime. In our testing, applications
were inaccessible for 15 minutes while the fix was being applied.</p>

<h1>Applying The Fix</h1>

<p>The following are step-by-step instructions on how to successfully migrate Locket
and Diego data from <code>postgres</code> and into their respective databases. This guide
will mention when downtime approximately starts and ends.</p>

<h2>Step 1: Get a Baseline</h2>

<p>Ensure your Cloud Foundry deployment is running properly by running smoke tests. If tests
pass, continue to step 2. Otherwise, please diagnose and correct your errors;
do not continue until smoke tests pass.</p>

<p>Running smoke tests will help you understand when, if ever, your Cloud Foundry deployment
stopped working in case data migration fails.</p>

<h2>Step 2: Stage Genesis Environment File for Deploy</h2>

<p>The Genesis Cloud Foundry Kit version 1.2.0 includes the fix to CF-M0001. Download it
via <code>genesis download cf/1.2.0</code> in your Cloud Foundry deployments folder. Then, edit your
environment file and set <code>version:</code> to <code>version: 1.2.0</code>. Do not deploy yet, that
step will come last.</p>

<h2>Step 3: Stop All BBS VMs</h2>

<p>Perform a <code>monit stop all</code> on all BBS instances of your Cloud Foundry deployment.
Approximately 2 minutes after stopping all processes, routes to your apps will
no longer work and downtime begins.</p>

<h2>Step 4: Migrate Data</h2>

<p>On your master Postgres VM, execute the following statements:</p>

<pre><code>sudo -i
mkdir /var/vcap/store/migration
cd /var/vcap/store/migration
</code></pre>

<p>Dump the data in the <code>postgres</code> database by individual table:</p>

<pre><code>export PATH=$PATH:/var/vcap/packages/postgres/bin
pg_dump -U vcap -p 6432    -t locks          postgres &gt; postgres.locks.sql;
pg_dump -U vcap -p 6432 -c -t actual_lrps    postgres &gt; postgres.actual_lrps.sql;
pg_dump -U vcap -p 6432 -c -t configurations postgres &gt; postgres.configurations.sql;
pg_dump -U vcap -p 6432 -c -t desired_lrps   postgres &gt; postgres.desired_lrps.sql;
pg_dump -U vcap -p 6432 -c -t domains        postgres &gt; postgres.domains.sql;
pg_dump -U vcap -p 6432 -c -t tasks          postgres &gt; postgres.tasks.sql;
</code></pre>

<p>Import the recently exported data from <code>postgres</code> into their proper databases:</p>

<pre><code>export PATH=$PATH:/var/vcap/packages/postgres/bin
psql -U vcap -p 6432 locketdb &lt; postgres.locks.sql;
psql -U vcap -p 6432 diegodb  &lt; postgres.actual_lrps.sql;
psql -U vcap -p 6432 diegodb  &lt; postgres.configurations.sql;
psql -U vcap -p 6432 diegodb  &lt; postgres.desired_lrps.sql;
psql -U vcap -p 6432 diegodb  &lt; postgres.domains.sql;
psql -U vcap -p 6432 diegodb  &lt; postgres.tasks.sql;
</code></pre>

<h2>Step 5: Verify the Data Migration was Successful</h2>

<p>Export the recently imported data:</p>

<pre><code>export PATH=$PATH:/var/vcap/packages/postgres/bin
pg_dump -U vcap -p 6432    -t locks          locketdb &gt; locketdb.locks.sql;
pg_dump -U vcap -p 6432 -c -t actual_lrps    diegodb  &gt; diegodb.actual_lrps.sql;
pg_dump -U vcap -p 6432 -c -t configurations diegodb  &gt; diegodb.configurations.sql;
pg_dump -U vcap -p 6432 -c -t desired_lrps   diegodb  &gt; diegodb.desired_lrps.sql;
pg_dump -U vcap -p 6432 -c -t domains        diegodb  &gt; diegodb.domains.sql;
pg_dump -U vcap -p 6432 -c -t tasks          diegodb  &gt; diegodb.tasks.sql;
</code></pre>

<p>Verify the recently exported data has no difference from the originally exported
data:</p>

<pre><code>diff postgres.locks.sql          locketdb.locks.sql;
diff postgres.actual_lrps.sql    diegodb.actual_lrps.sql;
diff postgres.configurations.sql diegodb.configurations.sql;
diff postgres.desired_lrps.sql   diegodb.desired_lrps.sql;
diff postgres.domains.sql        diegodb.domains.sql;
diff postgres.tasks.sql          diegodb.tasks.sql;
</code></pre>

<p>If all went well, there should be no output from any of those <code>diff</code> commands.</p>

<h2>Step 6: Rename Old Databases</h2>

<p>To ensure no processes reference old database tables, rename them:</p>

<pre><code>export PATH=$PATH:/var/vcap/packages/postgres/bin
psql -U vcap -p 6432 postgres -c "ALTER TABLE locks          RENAME TO locks_old";
psql -U vcap -p 6432 postgres -c "ALTER TABLE actual_lrps    RENAME TO actual_lrps_old";
psql -U vcap -p 6432 postgres -c "ALTER TABLE configurations RENAME TO configurations_old";
psql -U vcap -p 6432 postgres -c "ALTER TABLE desired_lrps   RENAME TO desired_lrps_old";
psql -U vcap -p 6432 postgres -c "ALTER TABLE domains        RENAME TO domains_old";
psql -U vcap -p 6432 postgres -c "ALTER TABLE tasks          RENAME TO tasks_old";
</code></pre>

<h2>Step 7: Redeploy Genesis Environment</h2>

<p>Execute <code>genesis deploy</code> of the affected environment, ensuring
you've followed step 2. Cloud Foundry will now deploy with proper references to the
database names.</p>

<p>If all went well, BBS will begin running again and routes will restore within a
minute after deploying. Downtime ends here.</p>

<h2>Step 8: Cleanup &amp; Verification (Final step)</h2>

<p>Execute smoke tests to verify that your redeployed Cloud Foundry environment
is operating properly.  Once you are satisfied with the results of the
migration, you may delete the old tables:</p>

<pre><code>export PATH=$PATH:/var/vcap/packages/postgres/bin
psql -U vcap -p 6432 postgres -c "DROP TABLE locks_old CASCADE";
psql -U vcap -p 6432 postgres -c "DROP TABLE actual_lrps_old CASCADE";
psql -U vcap -p 6432 postgres -c "DROP TABLE configurations_old CASCADE";
psql -U vcap -p 6432 postgres -c "DROP TABLE desired_lrps_old CASCADE";
psql -U vcap -p 6432 postgres -c "DROP TABLE domains_old CASCADE";
psql -U vcap -p 6432 postgres -c "DROP TABLE tasks_old CASCADE";
</code></pre>

<h1>Help &amp; Support</h1>

<p>If you have concerns about the impact of this migration process, or need
assistance running through it, please don't hesitate to
<a href="/community#slack">find us in #help on Slack</a>.</p>
      </div>
    </div>
  </div>
</section>

	<footer>
		<div class="container">
			<div class="row">
				<div class="col-md-4">
					<a class="logo" href="https://starkandwayne.com/">
						<img class="logo-white" alt="Stark & Wayne" src="/img/swlogo.png?2" />
						<p><strong>Genesis</strong> is funded and supported by <strong>Stark &amp; Wayne</strong>, the premier BOSH and Cloud Foundry consulting firm.<br>Stark &amp; Wayne: We Know Cloud.</p>
					</a>
				</div>

				<div class="col-md-4">
					<div class="links">
						<h5>Genesis</h5>
						<ul class="list">
							<li><a href="/download">Download Genesis</a></li>
							<li><a href="/docs/getting-started">Getting Started</a></li>
							<li><a href="/docs">Documentation</a></li>
							<li><a href="/community">Community Support</a></li>
						</ul>
					</div>
				</div>

				<div class="col-md-4">
					<div class="links">
						<h5>Reference</h5>
						<ul class="list">
							<li><a href="#">Genesis CLI</a></li>
							<li><a href="#">Pipelines</a></li>
							<li><a href="#">Genesis Kits</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div class="down-footer">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<p>&copy; 2018 Stark &amp; Wayne.  All Rights Reserved.</p>
						<ul class="footer-menu"></ul>
					</div>
				</div>
			</div>
		</div>
	</footer>

	<!-- FIXME: these don't exist: -->
	<!--[if lt IE 9]>
		<script type="text/javascript" src="/libs/html5shiv/es5-shim.min.js"></script>
		<script type="text/javascript" src="/libs/html5shiv/html5shiv.min.js"></script>
		<script type="text/javascript" src="/libs/html5shiv/html5shiv-printshiv.min.js"></script>
		<script type="text/javascript" src="/libs/respond/respond.min.js"></script>
	<![endif]-->

	<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
	<script type="text/javascript" src="/js/libs.js?2"></script>
	<script type="text/javascript" src="/js/common.js?2"></script>
</body>
</html>
