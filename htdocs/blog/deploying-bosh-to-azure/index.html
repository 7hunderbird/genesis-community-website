<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,target-densitydpi=device-dpi">
<meta name="generator" content="verse">
<meta name="X-UA-Compatible" content="IE=edge">


<meta name="twitter:card"       content="summary">


<meta property="og:type"        content="article">
<meta property="og:title"       content="Deploying a BOSH to Microsoft Azure Using Genesis and Terraform">
<meta property="og:site_name"   content="Genesis">
<meta property="og:url"         content="https://genesisproject.io/blog/deploying-bosh-to-azure">
<meta property="og:image"       content="https://genesisproject.io/blog/header/">
<meta property="og:description" content="FIXME - MARKETING ABSTRACT NEEDED STILL
">

<meta property="twitter:card"        content="summary">
<meta property="twitter:title"       content="Deploying a BOSH to Microsoft Azure Using Genesis and Terraform">
<meta property="twitter:description" content="FIXME - MARKETING ABSTRACT NEEDED STILL
">
<meta property="twitter:image"       content="https://genesisproject.io/blog/header/">

<title>Deploying a BOSH to Microsoft Azure Using Genesis and Terraform - Genesis</title>


<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/css/libs.css?6">
<link rel="stylesheet" href="/css/main.css?6">
<link rel="stylesheet" href="/css/extra.css?6">
<link rel="alternate home" type="application/rss+xml" title="Genesis - RSS feed" href="/feed.xml">
</head>
<body class="dark-load">
	<header id="top-nav" class="top-nav page-header">
		<div class="container">
			<a class="logo smooth-scroll" href="/">
				<img class="logo-white" alt="Stark & Wayne" src="/img/logo.png?6" />
			</a>
			<nav class="top-menu">
				<ul class="sf-menu">
					<li><a href="/">Home</a></li>
            <!--<li><a href="/blog">Blog</a></li>-->
					<li><a href="/download">Download</a></li>
					<li><a href="/community">Community</a></li>
					<li><a href="/docs/getting-started">Docs</a></li>
          <!--<li><a href="/dev">Developers</a></li>-->
				</ul>
			</nav>
			<div id="mobile-menu">
				<div class="inner-wrap">
					<nav>
						<ul class="nav_menu">
							<li><a href="/">Home</a></li>
							<li><a href="/download">Download</a></li>
							<li><a href="/docs">Documentation</a></li>
              <!--<li><a href="/dev">Developers</a></li>-->
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</header>

	

<section id="top" class="display-page img-parallax bg-mask background-image"
         data-image="/img/hbg.jpg">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Deploying a BOSH to Microsoft Azure Using Genesis and Terraform</h1>
      </div>
    </div>
  </div>
</section>


<section class="page">
  <div id="container" class="container">
    <div class="row">
      <div class="col-md-10 col-md-push-1">
        <div class="content">
        	<h2>Table of Contents</h2>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#getting-automation-credentials">Getting Automation Credentials</a></li>
<li><a href="#setting-up-terraform">Setting Up Terraform</a></li>
<li><a href="#setting-up-your-bastion-host">Setting Up Your Bastion Host</a></li>
<li><a href="#starting-a-local-vault-instance">Starting a Local Vault Instance</a></li>
<li><a href="#deploying-a-new-proto-bosh">Deploying a New Proto-BOSH</a></li>
<li><a href="#logging-into-bosh">Logging Into BOSH</a></li>
<li><a href="#generating-and-uploading-a-cloud-config">Generating and Uploading a Cloud Config</a></li>
<li><a href="#next-steps">Next Steps</a></li>
</ul>

<p><a name="introduction"></a></p>

<h2>Introduction</h2>

<p>BOSH can be an effective way to manage your infrastructure, but before you
have a BOSH director, you've got to bootstrap your infrastructure to a point
where you can deploy a BOSH Director to it. In this post, we'll cover setting
up an automation account, using Terraform to configure Azure all the way up
to making a network for your new BOSH director, and using Genesis to quickly
configure and deploy your BOSH director.</p>

<p><a name="prerequisites"></a></p>

<h2>Prerequisites</h2>

<p>This post does not cover the installation of the Genesis toolchain (genesis,
spruce, etc.). It is expected that you have these things installed already.</p>

<p>You'll need to create your own Azure account and subscription (or have your
organization create one for you). Your account will need ownership privilege
over the subscription in order to make automation credentials. If you don't
have these privileges, you'll need somebody to take the steps in the next
section for you.</p>

<p><a name="getting-automation-credentials"></a></p>

<h2>Getting Automation Credentials</h2>

<p>App registrations in Azure are automation accounts. We're going to need one of
these so that Terraform and BOSH can authenticate and manipulate resources. To
create one, first log in to the Azure portal (portal.azure.com).</p>

<p>Once logged in, navigate to the <code>Azure Active Directory</code> on your sidebar. This
presents a new sidebar, on which you should navigate to <code>App registrations</code>.
This will open up yet another bar - this time a horizontal one - and you should
click on <code>New registration</code> therein.</p>

<p>Now you have a small form to complete. It will ask you to provide a display
name for the application, the account type, and a redirect URI. The display
name can be whatever you want it to be. The account type will almost always
be set to <code>Accounts in this organizational directory only</code>, and the redirect
URI can be left blank for our use cases. The Redirect URI type can be set to
web.</p>

<p>Once you apply the settings, you should be brought to the app's overview page.
If you should navigate away for any reason, you can come back to this page by
finding it in the list of app registrations in the Azure Active Directory panel.
This page contains a few pieces of information we need. To authenticate as an
application, we need a set of credentials that Azure refers to as a "service
principal". This includes the following:</p>

<ul>
<li>Application ID</li>
<li>Client Secret</li>
<li>Tenant ID</li>
</ul>

<p>This page contains the application ID and tenant ID. Take note of them, and
then navigate to <code>Certificates &amp; secrets</code>. Create a new client secret; set the
expiry to something you're comfortable with (secrets can be rotated at a later
time). Then, take the output value and note that down as well.</p>

<p>We will also need the ID of the subscription that resources will be created in
(and billed to). To find the ID, search <code>Subscriptions</code> in the top bar, go to
the list of subscriptions and select the desired subscription from the list.
Copy the ID and note it down.</p>

<p>While you're still on the subscription page, you can give the application
you created access to create resources in the target subscription. To d
so, click on <code>Access Control (IAM)</code> on the sidebar, and then <code>Add a role
assignment</code>. Search for and select the name of the application you previously
created, and give it the role of <code>Contributor</code>.</p>

<p><a name="setting-up-terraform"></a></p>

<h2>Setting up Terraform</h2>

<p>Now that we have automation credentials, we can start standing up
infrastructure using Terraform. Terraform binaries and documentation can be
found at <a href="https://terraform.io">https://terraform.io</a>.</p>

<p>We've already made a basic Terraform file for you that can stand up your
control plane if given a few extra parameters. You can find that file
<a href="https://github.com/genesis-community/terraforms/tree/master/controlplane/azure">here</a>.</p>

<p>There is also a <code>terraform.tfvars.example</code> file in that directory that can be
used as a basis for creating your <code>terraform.tfvars</code> file. It contains all of
the possible parameters you can specify for your deployment.</p>

<p>The <code>subscription_id</code>, <code>tenant_id</code>, <code>client_id</code>, and <code>client_secret</code> were all
values that you should have taken note of while making your app registration.
The <code>resource_group_name</code> is the name of the resource group that you'd like
Terraform to create. </p>

<p>The <code>location</code> is the Azure location that you wish resources to be created in. </p>

<p>The <code>starting_address</code> is the first address of a <code>/16</code> range you'd like the
network to use. Try to select a range that isn't in use elsewhere in your
subscription, in case you ever decide to peer the networks.</p>

<p><code>dns_servers</code> are the default dns servers that will be used by resources in the
network. By default, its set to use the public Cloudflare servers.</p>

<p><code>ssh_keys</code> are the public keys that will be put on in the <code>authorized_keys</code>
file of the bastion box that gets created. You'll need to provide one in order
to log in.</p>

<p>Once configured, run the following from the directory with your <code>azure.tf</code> and
<code>terraform.tfvars</code> file.</p>

<p><code>
terraform apply
</code></p>

<p>Take note of the output variables after a successful apply, as they contain the
answers to many of the questions that Genesis will ask you later.</p>

<p><a name="setting-up-your-bastion-host"></a></p>

<h2>Setting Up Your Bastion Host</h2>

<p>Once your bastion box is created, you should be able to ssh into it if you
configured your Terraform file properly. Once inside, you'll need to install
the tools needed for Genesis. For instructions on how to install these tools,
see <a href="https://github.com/genesis-community/website/blob/master/blogs/toolchain/install.md">this document</a>.</p>

<p><a name="starting-a-local-vault-instance"></a></p>

<h2>Starting a Local Vault Instance</h2>

<p>We use the <a href="https://github.com/starkandwayne/safe">Safe CLI</a> to interact with
Vault in general. You should have it installed after after following the
instructions on setting up your bastion host. We're going to use Safe to
quickly set up a temporary local Vault instance that Genesis can use until we
are able to set up a permanent Vault through BOSH at a later time.</p>

<p>To do this, open a separate shell session / tmux pane on the jumpbox and run </p>

<p><code>
safe local --memory
</code></p>

<p>Safe will output the target name of the new Vault, target it, and authenticate
to it automatically.</p>

<p><a name="deploying-a-new-proto-bosh"></a></p>

<h2>Deploying a New Proto-BOSH</h2>

<p>Navigate to the directory in which you would like to store the Genesis
deployment directory and run </p>

<p><code>
genesis init bosh -k bosh
</code></p>

<p>Newer versions of genesis will prompt you at this point about which Vault
you would like to use. Select the target that was created by <code>safe local</code>.</p>

<p><code>cd</code> into the newly created directory. Now we need to tell Genesis to
initialize the configuration file for a new proto-BOSH director deployment.
Decide what you would like to call this environment. We typically recommend
an <code>&lt;org&gt;-&lt;site&gt;-&lt;env&gt;</code> naming scheme. I'll call mine <code>snw-eastus-controlplane</code>.
Once this is determined, run <code>genesis new</code> with the environment name.</p>

<p><code>
genesis new snw-eastus-controlplane
</code></p>

<p>You'll now be walked through a series of questions about the deployment you're
about to make. The prompts will look something like the following:</p>

<p>```
ubuntu@bastion:~/deployments/bosh-deployments$ genesis new snw-eastus-controlplane
Setting up new environment snw-eastus-controlplane...</p>

<p>Using vault at http://127.0.0.1:8201.
Verifying availability...ok</p>

<p>Is this a proto-BOSH director?
[y|n] > y</p>

<p>What static IP do you want to deploy this BOSH director on?</p>

<blockquote>
  <p>10.0.0.5</p>
</blockquote>

<p>What network should this BOSH director exist in (in CIDR notation)?</p>

<blockquote>
  <p>10.0.0.0/24</p>
</blockquote>

<p>What default gateway (IP address) should this BOSH director use?</p>

<blockquote>
  <p>10.0.0.1</p>
</blockquote>

<p>What DNS servers should BOSH use? (leave value empty to end)
1st value > 1.1.1.1
2nd value > 1.0.0.1
3rd value ></p>

<p>What IaaS will this BOSH director orchestrate?
  1) VMWare vSphere
  2) Amazon Web Services
  3) Microsoft Azure
  4) Google Cloud Platform
  5) OpenStack
  6) BOSH Warden</p>

<p>Select choice > Microsoft Azure</p>

<p>What is your Azure Client ID?</p>

<blockquote>
  <p>01234567-89ab-cdef-0123-456789abcdef
What is your Azure Client Secret?
client<em>secret [hidden]:
client</em>secret [confirm]:</p>
</blockquote>

<p>What is your Azure Tenant ID?</p>

<blockquote>
  <p>01234567-89ab-cdef-0123-456789abcdef</p>
</blockquote>

<p>What is your Azure Subscription ID?</p>

<blockquote>
  <p>01234567-89ab-cdef-0123-456789abcdef</p>
</blockquote>

<p>What Azure Resource Group will BOSH be deploying VMs into?</p>

<blockquote>
  <p>genesis</p>
</blockquote>

<p>What security group should be used as the BOSH default security group?</p>

<blockquote>
  <p>genesis-sg</p>
</blockquote>

<p>What is the name of your Azure Virtual Network?</p>

<blockquote>
  <p>genesis-network</p>
</blockquote>

<p>What is the name of the Azure subnet that the BOSH will be placed in?</p>

<blockquote>
  <p>genesis-controlplane-subnet</p>
</blockquote>

<p>Would you like to edit the environment file?
[y|n] > n
 - auto-generating credentials (in secret/snw/eastus/controlplane/bosh)...
 - auto-generating certificates (in secret/snw/eastus/controlplane/bosh)...
New environment snw-eastus-controlplane provisioned!</p>

<p>To deploy, run this:</p>

<p>genesis deploy 'snw-eastus-controlplane'</p>

<p>```</p>

<p>Of note, if this is your first BOSH, then this <em>is</em> a Proto-BOSH director.
Also, if you've read this far, the IaaS you're targeting is likely Microsoft
Azure. The remaining answers can be found in the outputs of your Terraform
apply or in your <code>terraform.tfvars</code> file.</p>

<p>The command will then spend some time generating certificates and secrets for
the deployment to use. These will get stored in the Vault and made accessible
by the <code>safe</code> utility.</p>

<p>An environment file named after your environment name (e.g.
<code>snw-eastus-controlplane.yml</code>) will be created. This contains all non-sensitive
information about your deployment. It is safe to store in version control. If
you needed to change anything about your deployment, you would make your changes
in this file. For the purpose of this tutorial, we will assume that the defaults
are fine and that you don't need to make changes to this file.</p>

<p>You should now be able to run</p>

<p><code>
genesis deploy snw-eastus-controlplane
</code></p>

<p>Substitute <code>snw-eastus-controlplane</code> with the name of your environment (the
argument you gave to <code>genesis new</code>). Genesis should handle the rest of the
deployment for you.</p>

<p><a name="logging-into-bosh"></a></p>

<h2>Logging Into BOSH</h2>

<p>To log in to the BOSH director, you can run:</p>

<p><code>
genesis do snw-eastus-controlplane -- alias
genesis do snw-eastus-controlplane -- login
</code></p>

<p>Substitute snw-eastus-controlplane with your own environment name.</p>

<p><a name="generating-and-uploading-a-cloud-config"></a></p>

<h2>Generating and Uploading a Cloud Config</h2>

<p>The BOSH cloud config contains shared information about all the deployments
you'll be deploying to your control plane environment. This includes the
network IP allocations, VM sizes, disk sizes, availability zone configurations,
and compilation VM configuration.</p>

<p>We've provided a spruce file which, when merged with a YAML configuration file,
will generate a working cloud config for you. Take the <code>cloud_config.yml</code> file
from the 
<a href="https://github.com/genesis-community/terraforms/tree/master/controlplane/azure">terraform repo</a>
and copy it into a temporary location on your jumpbox. Call this copy
<code>cloud_config.yml</code> as well. Also copy the <code>cloud_config_meta.yml.example</code> file
into a file called <code>cloud_config_meta.yml</code>. That file should look something
like this:</p>

<p><code>yml
meta:
  vnet:
    name: genesis-network
  subnet:
    name: genesis-subnet
  dns_servers:
  - 1.1.1.1
  - 1.0.0.1
  ip_prefix: "10.0.0."
</code></p>

<p>The values need to be changed to match your Azure configuration.
<code>meta.vnet.name</code> and <code>meta.subnet.name</code> are the name of your Azure virtual
network and subnet as printed out by Terraform, respectively.
<code>meta.dns_servers</code> is the array of DNS servers you configured that were also
output by Terraform.</p>

<p><code>meta.ip_prefix</code> is a bit of a kludge due to limitations in how spruce works.
Give it the first three octets of the network address of your controlplane
subnet, ending with a <code>.</code>.</p>

<p>Once that's put together, run </p>

<p><code>
mkdir director-configs
spruce merge --prune meta cloud_config.yml cloud_config_meta.yml &gt; director-configs/controlplane.yml
</code></p>

<p>Put that output <code>controlplane.yml</code> file into a place where you'd like to keep
the offline versions of your BOSH cloud configs (preferably in a Git repo).</p>

<p>Make sure that you're logged into bosh. Then run</p>

<p><code>
bosh -e snw-eastus-controlplane update-cloud-config controlplane.yml
</code></p>

<p>Where <code>snw-eastus-controlplane</code> is whatever you called your controlplane
environment. Now your cloud config should be uploaded and ready to go.</p>

<p><a name="next-steps"></a></p>

<h2>Next Steps</h2>

<p>If you're building out a full environment, at this point you should be looking
to deploy a permanent Vault. With your new BOSH. We're working on making a document
on this in-particular, and this section will be updated with a link to that once it
is completed.</p>
		</div>
      </div>
    </div>
  </div>
</section>

	<footer>
		<div class="container">
			<div class="row">
				<div class="col-md-4">
					<a class="logo" href="https://starkandwayne.com/">
						<img class="logo-white" alt="Stark & Wayne" src="/img/swlogo.png?6" />
						<p><strong>Genesis</strong> is funded and supported by <strong>Stark &amp; Wayne</strong>, the premier BOSH and Cloud Foundry consulting firm.<br>Stark &amp; Wayne: We Know Cloud.</p>
					</a>
				</div>

				<div class="col-md-4">
					<div class="links">
						<h5>Genesis</h5>
						<ul class="list">
							<li><a href="/download">Download Genesis</a></li>
							<li><a href="/docs/getting-started">Getting Started</a></li>
							<li><a href="/community">Community Support</a></li>
						</ul>
					</div>
				</div>

        <!--
				<div class="col-md-4">
					<div class="links">
						<h5>Reference</h5>
						<ul class="list">
							<li><a href="#">Genesis CLI</a></li>
							<li><a href="#">Pipelines</a></li>
							<li><a href="#">Genesis Kits</a></li>
						</ul>
					</div>
				</div>
        -->
			</div>
		</div>

		<div class="down-footer">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<p>&copy; 2018 Stark &amp; Wayne.  All Rights Reserved.</p>
						<ul class="footer-menu"></ul>
					</div>
				</div>
			</div>
		</div>
	</footer>

	<!-- FIXME: these don't exist: -->
	<!--[if lt IE 9]>
		<script type="text/javascript" src="/libs/html5shiv/es5-shim.min.js"></script>
		<script type="text/javascript" src="/libs/html5shiv/html5shiv.min.js"></script>
		<script type="text/javascript" src="/libs/html5shiv/html5shiv-printshiv.min.js"></script>
		<script type="text/javascript" src="/libs/respond/respond.min.js"></script>
	<![endif]-->

	<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
	<script type="text/javascript" src="/js/libs.js?6"></script>
	<script type="text/javascript" src="/js/common.js?6"></script>
</body>
</html>
